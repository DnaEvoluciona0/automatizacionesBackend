{% extends 'autorepcuentas/base.html' %}

{% block title %}Extraccion de Datos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-cloud-download me-2"></i>Extraccion de Datos</h2>
</div>

<!-- Info -->
<div class="alert alert-warning mb-4">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <strong>Importante:</strong> La extraccion de datos consulta la API de Meta Ads.
    Asegurate de tener tokens validos en config.json.
</div>

<!-- Extraction Form -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4"><i class="bi bi-gear me-2"></i>Configurar Extraccion Masiva</h5>

                <div class="mb-3">
                    <label class="form-label">Tipo de Datos a Extraer</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkCampaigns" checked>
                        <label class="form-check-label" for="chkCampaigns">
                            <i class="bi bi-megaphone me-1"></i> Campaigns
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkAdsets">
                        <label class="form-check-label" for="chkAdsets">
                            <i class="bi bi-collection me-1"></i> AdSets
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkAds">
                        <label class="form-check-label" for="chkAds">
                            <i class="bi bi-file-earmark-play me-1"></i> Ads
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label d-flex justify-content-between align-items-center">
                        <span>Seleccionar Cuentas</span>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllCuentas()">
                                Todas
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllCuentas()">
                                Ninguna
                            </button>
                        </div>
                    </label>
                    <div class="border rounded p-2" style="max-height: 250px; overflow-y: auto;">
                        {% for cuenta in cuentas %}
                        <div class="form-check">
                            <input class="form-check-input cuenta-checkbox" type="checkbox"
                                   value="{{ cuenta.account_key }}"
                                   id="cuenta_{{ cuenta.account_key }}"
                                   data-nombre="{{ cuenta.account_name }}">
                            <label class="form-check-label" for="cuenta_{{ cuenta.account_key }}">
                                <strong>[{{ cuenta.account_key }}]</strong> {{ cuenta.account_name }}
                                <small class="text-muted d-block">{{ cuenta.marcas }}</small>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Delay entre cuentas (segundos)</label>
                    <input type="number" class="form-control" id="delaySegundos" value="5" min="1" max="60">
                    <small class="text-muted">Tiempo de espera entre cada cuenta para evitar rate limits</small>
                </div>

                <button class="btn btn-primary btn-action w-100" onclick="iniciarExtraccionMasiva()" id="btnIniciar">
                    <i class="bi bi-cloud-download me-2"></i>Iniciar Extraccion Masiva
                </button>

                <button class="btn btn-danger btn-action w-100 mt-2 d-none" onclick="detenerExtraccion()" id="btnDetener">
                    <i class="bi bi-stop-circle me-2"></i>Detener Extraccion
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0"><i class="bi bi-terminal me-2"></i>Log de Extraccion</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                        <i class="bi bi-trash"></i> Limpiar
                    </button>
                </div>
                <div id="logContainer" class="bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    <div class="text-muted">Esperando extraccion...</div>
                </div>

                <!-- Progress -->
                <div class="mt-3 d-none" id="progressContainer">
                    <div class="d-flex justify-content-between mb-1">
                        <span id="progressText">Procesando...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="card">
    <div class="card-body">
        <h5 class="card-title mb-4"><i class="bi bi-table me-2"></i>Resultados de Extraccion</h5>
        <div class="table-responsive">
            <table class="table table-modern table-hover">
                <thead>
                    <tr>
                        <th>Cuenta</th>
                        <th>Tipo</th>
                        <th>Insertados</th>
                        <th>Actualizados</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody id="tablaResultados">
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Inicia una extraccion para ver los resultados
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const logContainer = document.getElementById('logContainer');
let stopExtraction = false;
let extractionResults = [];

function addLog(message, type = 'info') {
    const colors = {
        'info': '#17a2b8',
        'success': '#28a745',
        'error': '#dc3545',
        'warning': '#ffc107',
        'highlight': '#00ff00'
    };
    const timestamp = new Date().toLocaleTimeString();
    const line = document.createElement('div');
    line.innerHTML = `<span style="color: ${colors[type]}">[${timestamp}]</span> ${message}`;
    logContainer.appendChild(line);
    logContainer.scrollTop = logContainer.scrollHeight;
}

function clearLog() {
    logContainer.innerHTML = '<div class="text-muted">Esperando extraccion...</div>';
    extractionResults = [];
    document.getElementById('tablaResultados').innerHTML = `
        <tr>
            <td colspan="6" class="text-center text-muted">
                Inicia una extraccion para ver los resultados
            </td>
        </tr>
    `;
}

function selectAllCuentas() {
    document.querySelectorAll('.cuenta-checkbox').forEach(cb => cb.checked = true);
}

function deselectAllCuentas() {
    document.querySelectorAll('.cuenta-checkbox').forEach(cb => cb.checked = false);
}

function updateProgress(current, total, text) {
    const percent = Math.round((current / total) * 100);
    document.getElementById('progressBar').style.width = `${percent}%`;
    document.getElementById('progressPercent').textContent = `${percent}%`;
    document.getElementById('progressText').textContent = text;
}

function showProgress() {
    document.getElementById('progressContainer').classList.remove('d-none');
}

function hideProgress() {
    document.getElementById('progressContainer').classList.add('d-none');
}

function detenerExtraccion() {
    stopExtraction = true;
    addLog('Deteniendo extraccion...', 'warning');
}

async function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function iniciarExtraccionMasiva() {
    // Obtener cuentas seleccionadas
    const cuentasSeleccionadas = [];
    document.querySelectorAll('.cuenta-checkbox:checked').forEach(cb => {
        cuentasSeleccionadas.push({
            key: cb.value,
            nombre: cb.dataset.nombre
        });
    });

    if (cuentasSeleccionadas.length === 0) {
        showAlert('Por favor selecciona al menos una cuenta', 'warning');
        return;
    }

    const extractCampaigns = document.getElementById('chkCampaigns').checked;
    const extractAdsets = document.getElementById('chkAdsets').checked;
    const extractAds = document.getElementById('chkAds').checked;

    if (!extractCampaigns && !extractAdsets && !extractAds) {
        showAlert('Selecciona al menos un tipo de datos', 'warning');
        return;
    }

    const delaySeconds = parseInt(document.getElementById('delaySegundos').value) || 5;

    // Reset
    stopExtraction = false;
    extractionResults = [];
    clearLog();

    // UI
    document.getElementById('btnIniciar').classList.add('d-none');
    document.getElementById('btnDetener').classList.remove('d-none');
    showProgress();

    const tiposSeleccionados = [];
    if (extractCampaigns) tiposSeleccionados.push('campaigns');
    if (extractAdsets) tiposSeleccionados.push('adsets');
    if (extractAds) tiposSeleccionados.push('ads');

    const totalOperaciones = cuentasSeleccionadas.length * tiposSeleccionados.length;
    let operacionActual = 0;

    addLog(`Iniciando extraccion masiva...`, 'highlight');
    addLog(`Cuentas: ${cuentasSeleccionadas.length} | Tipos: ${tiposSeleccionados.join(', ')}`, 'info');
    addLog(`Total de operaciones: ${totalOperaciones}`, 'info');
    addLog(`Delay entre cuentas: ${delaySeconds} segundos`, 'info');
    addLog('â”€'.repeat(50), 'info');

    for (let i = 0; i < cuentasSeleccionadas.length; i++) {
        if (stopExtraction) {
            addLog('Extraccion detenida por el usuario', 'warning');
            break;
        }

        const cuenta = cuentasSeleccionadas[i];
        addLog(``, 'info');
        addLog(`ðŸ“ [${i + 1}/${cuentasSeleccionadas.length}] Procesando: ${cuenta.nombre}`, 'highlight');

        for (const tipo of tiposSeleccionados) {
            if (stopExtraction) break;

            operacionActual++;
            updateProgress(operacionActual, totalOperaciones, `${cuenta.nombre} - ${tipo}`);

            try {
                addLog(`  â†³ Extrayendo ${tipo}...`, 'info');

                const response = await fetch(`/auto/marketing/${tipo}/sync/?account_key=${cuenta.key}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    const inserted = data.inserted || 0;
                    const updated = data.updated || 0;
                    addLog(`  âœ“ ${tipo}: ${inserted} insertados, ${updated} actualizados`, 'success');

                    extractionResults.push({
                        cuenta: cuenta.nombre,
                        tipo: tipo,
                        inserted: inserted,
                        updated: updated,
                        estado: 'success'
                    });
                } else {
                    addLog(`  âœ— ${tipo}: ${data.message}`, 'error');
                    extractionResults.push({
                        cuenta: cuenta.nombre,
                        tipo: tipo,
                        inserted: 0,
                        updated: 0,
                        estado: 'error',
                        message: data.message
                    });
                }
            } catch (error) {
                addLog(`  âœ— ${tipo}: ${error.message}`, 'error');
                extractionResults.push({
                    cuenta: cuenta.nombre,
                    tipo: tipo,
                    inserted: 0,
                    updated: 0,
                    estado: 'error',
                    message: error.message
                });
            }
        }

        // Delay entre cuentas (excepto la ultima)
        if (i < cuentasSeleccionadas.length - 1 && !stopExtraction) {
            addLog(`  â³ Esperando ${delaySeconds} segundos...`, 'warning');
            await sleep(delaySeconds * 1000);
        }
    }

    // Finalizar
    addLog('â”€'.repeat(50), 'info');
    addLog(`Extraccion ${stopExtraction ? 'detenida' : 'completada'}!`, stopExtraction ? 'warning' : 'success');

    // Resumen
    const exitosos = extractionResults.filter(r => r.estado === 'success').length;
    const errores = extractionResults.filter(r => r.estado === 'error').length;
    const totalInserted = extractionResults.reduce((sum, r) => sum + r.inserted, 0);
    const totalUpdated = extractionResults.reduce((sum, r) => sum + r.updated, 0);

    addLog(`Resumen: ${exitosos} exitosos, ${errores} errores`, 'info');
    addLog(`Total: ${totalInserted} insertados, ${totalUpdated} actualizados`, 'info');

    // UI
    document.getElementById('btnIniciar').classList.remove('d-none');
    document.getElementById('btnDetener').classList.add('d-none');
    hideProgress();

    updateResultsTable();
    showAlert(`Extraccion completada: ${exitosos} exitosos, ${errores} errores`, exitosos > 0 ? 'success' : 'warning');
}

function updateResultsTable() {
    const tbody = document.getElementById('tablaResultados');
    tbody.innerHTML = '';

    if (extractionResults.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    No hay resultados
                </td>
            </tr>
        `;
        return;
    }

    extractionResults.forEach(r => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${r.cuenta}</td>
            <td><span class="badge bg-secondary">${r.tipo}</span></td>
            <td>${r.inserted}</td>
            <td>${r.updated}</td>
            <td>
                <span class="badge bg-${r.estado === 'success' ? 'success' : 'danger'}">
                    ${r.estado === 'success' ? 'OK' : 'Error'}
                </span>
                ${r.message ? `<small class="d-block text-danger">${r.message.substring(0, 50)}...</small>` : ''}
            </td>
            <td>${new Date().toLocaleString()}</td>
        `;
        tbody.appendChild(row);
    });
}
</script>
{% endblock %}
