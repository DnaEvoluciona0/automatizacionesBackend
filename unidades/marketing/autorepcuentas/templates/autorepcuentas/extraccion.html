{% extends 'autorepcuentas/base.html' %}

{% block title %}Extraccion de Datos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-cloud-download me-2"></i>Extraccion de Datos</h2>
</div>

<!-- Info -->
<div class="alert alert-warning mb-4">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <strong>Importante:</strong> La extraccion de datos consulta la API de Meta Ads.
    Asegurate de tener tokens validos en config.json.
</div>

<!-- Extraction Form -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4"><i class="bi bi-gear me-2"></i>Configurar Extraccion</h5>

                <div class="mb-3">
                    <label class="form-label">Seleccionar Cuenta</label>
                    <select class="form-select" id="selectCuenta">
                        <option value="">-- Selecciona una cuenta --</option>
                        {% for cuenta in cuentas %}
                        <option value="{{ cuenta.account_key }}" {% if selected_account == cuenta.account_key %}selected{% endif %}>
                            [{{ cuenta.account_key }}] {{ cuenta.account_name }} - {{ cuenta.marcas }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Tipo de Datos</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkCampaigns" checked>
                        <label class="form-check-label" for="chkCampaigns">
                            <i class="bi bi-megaphone me-1"></i> Campaigns
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkAdsets" checked>
                        <label class="form-check-label" for="chkAdsets">
                            <i class="bi bi-collection me-1"></i> AdSets
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="chkAds" checked>
                        <label class="form-check-label" for="chkAds">
                            <i class="bi bi-file-earmark-play me-1"></i> Ads
                        </label>
                    </div>
                </div>

                <button class="btn btn-primary btn-action w-100" onclick="iniciarExtraccion()">
                    <i class="bi bi-cloud-download me-2"></i>Iniciar Extraccion
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4"><i class="bi bi-terminal me-2"></i>Log de Extraccion</h5>
                <div id="logContainer" class="bg-dark text-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    <div class="text-muted">Esperando extraccion...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Extraction All -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title mb-4"><i class="bi bi-lightning-charge me-2"></i>Extraccion Masiva</h5>
        <p class="text-muted">Extrae datos de todas las cuentas configuradas. Este proceso puede tardar varios minutos.</p>
        <button class="btn btn-warning btn-action" onclick="extraccionMasiva()">
            <i class="bi bi-cloud-download me-2"></i>Extraer TODAS las Cuentas
        </button>
    </div>
</div>

<!-- Results Table -->
<div class="card">
    <div class="card-body">
        <h5 class="card-title mb-4"><i class="bi bi-table me-2"></i>Resultados de Extraccion</h5>
        <div class="table-responsive">
            <table class="table table-modern table-hover">
                <thead>
                    <tr>
                        <th>Cuenta</th>
                        <th>Tipo</th>
                        <th>Registros</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody id="tablaResultados">
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Inicia una extraccion para ver los resultados
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const logContainer = document.getElementById('logContainer');

function addLog(message, type = 'info') {
    const colors = {
        'info': '#17a2b8',
        'success': '#28a745',
        'error': '#dc3545',
        'warning': '#ffc107'
    };
    const timestamp = new Date().toLocaleTimeString();
    const line = document.createElement('div');
    line.innerHTML = `<span style="color: ${colors[type]}">[${timestamp}]</span> ${message}`;
    logContainer.appendChild(line);
    logContainer.scrollTop = logContainer.scrollHeight;
}

function clearLog() {
    logContainer.innerHTML = '';
}

async function iniciarExtraccion() {
    const accountKey = document.getElementById('selectCuenta').value;
    if (!accountKey) {
        showAlert('Por favor selecciona una cuenta', 'warning');
        return;
    }

    const extractCampaigns = document.getElementById('chkCampaigns').checked;
    const extractAdsets = document.getElementById('chkAdsets').checked;
    const extractAds = document.getElementById('chkAds').checked;

    if (!extractCampaigns && !extractAdsets && !extractAds) {
        showAlert('Selecciona al menos un tipo de datos', 'warning');
        return;
    }

    clearLog();
    addLog('Iniciando extraccion...', 'info');
    showLoading('Extrayendo datos de Meta API...');

    const results = [];

    try {
        // Extract Campaigns
        if (extractCampaigns) {
            addLog('Extrayendo Campaigns...', 'info');
            const response = await fetch(`/auto/marketing/campaigns/sync/?account_key=${accountKey}`, { method: 'POST' });
            const data = await response.json();
            if (data.status === 'success') {
                addLog(`Campaigns: ${data.inserted || 0} insertados, ${data.updated || 0} actualizados`, 'success');
                results.push({ tipo: 'Campaigns', registros: (data.inserted || 0) + (data.updated || 0), estado: 'success' });
            } else {
                addLog(`Error Campaigns: ${data.message}`, 'error');
                results.push({ tipo: 'Campaigns', registros: 0, estado: 'error' });
            }
        }

        // Extract AdSets
        if (extractAdsets) {
            addLog('Extrayendo AdSets...', 'info');
            const response = await fetch(`/auto/marketing/adsets/sync/?account_key=${accountKey}`, { method: 'POST' });
            const data = await response.json();
            if (data.status === 'success') {
                addLog(`AdSets: ${data.inserted || 0} insertados, ${data.updated || 0} actualizados`, 'success');
                results.push({ tipo: 'AdSets', registros: (data.inserted || 0) + (data.updated || 0), estado: 'success' });
            } else {
                addLog(`Error AdSets: ${data.message}`, 'error');
                results.push({ tipo: 'AdSets', registros: 0, estado: 'error' });
            }
        }

        // Extract Ads
        if (extractAds) {
            addLog('Extrayendo Ads...', 'info');
            const response = await fetch(`/auto/marketing/ads/sync/?account_key=${accountKey}`, { method: 'POST' });
            const data = await response.json();
            if (data.status === 'success') {
                addLog(`Ads: ${data.ads_count || 0} extraidos`, 'success');
                results.push({ tipo: 'Ads', registros: data.ads_count || 0, estado: 'success' });
            } else {
                addLog(`Error Ads: ${data.message}`, 'error');
                results.push({ tipo: 'Ads', registros: 0, estado: 'error' });
            }
        }

        hideLoading();
        addLog('Extraccion completada!', 'success');
        showAlert('Extraccion completada exitosamente', 'success');
        updateResultsTable(accountKey, results);

    } catch (error) {
        hideLoading();
        addLog(`Error: ${error.message}`, 'error');
        showAlert(`Error: ${error.message}`, 'danger');
    }
}

function updateResultsTable(accountKey, results) {
    const tbody = document.getElementById('tablaResultados');
    tbody.innerHTML = '';

    results.forEach(r => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>Cuenta ${accountKey}</td>
            <td>${r.tipo}</td>
            <td>${r.registros}</td>
            <td><span class="badge bg-${r.estado === 'success' ? 'success' : 'danger'}">${r.estado === 'success' ? 'OK' : 'Error'}</span></td>
            <td>${new Date().toLocaleString()}</td>
        `;
        tbody.appendChild(row);
    });
}

async function extraccionMasiva() {
    if (!confirm('Esto extraera datos de TODAS las cuentas. El proceso puede tardar varios minutos. Continuar?')) {
        return;
    }

    clearLog();
    addLog('Iniciando extraccion masiva...', 'warning');
    showLoading('Extrayendo datos de todas las cuentas...');

    // TODO: Implementar extraccion masiva
    addLog('Funcion en desarrollo...', 'info');
    hideLoading();
}
</script>
{% endblock %}
