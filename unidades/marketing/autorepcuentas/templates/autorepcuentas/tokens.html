{% extends 'autorepcuentas/base.html' %}

{% block title %}Gestion de Tokens{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-key me-2"></i>Gestion de Tokens</h2>
    <div>
        <button class="btn btn-outline-primary me-2" onclick="verificarTodos()">
            <i class="bi bi-arrow-clockwise me-1"></i>Verificar Todos
        </button>
        <button class="btn btn-primary" onclick="renovarTodos()">
            <i class="bi bi-arrow-repeat me-1"></i>Renovar Proximos a Expirar
        </button>
    </div>
</div>

<!-- Info Card -->
<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Renovacion Automatica:</strong> Los tokens se renuevan automaticamente cada <strong>Lunes a las 9:00 AM</strong>.
    Solo se renuevan tokens con menos de 15 dias de validez.
</div>

<!-- Resumen -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary">{{ resumen.total }}</h3>
                <small>Total</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">{{ resumen.ok }}</h3>
                <small>OK</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-warning">{{ resumen.advertencia }}</h3>
                <small>Advertencia</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-danger">{{ resumen.critico }}</h3>
                <small>Critico</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-danger">{{ resumen.expirado|add:resumen.invalido }}</h3>
                <small>Expirado/Invalido</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-secondary">{{ resumen.sin_token|add:resumen.sin_credenciales }}</h3>
                <small>Sin Config</small>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Tokens -->
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0"><i class="bi bi-list-ul me-2"></i>Estado de Tokens</h5>
            <small class="text-muted">Ultima verificacion: {{ fecha_verificacion }}</small>
        </div>
        <div class="table-responsive">
            <table class="table table-modern table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Cuenta</th>
                        <th>Estado</th>
                        <th>Dias Restantes</th>
                        <th>Expiracion</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaTokens">
                    {% for token in tokens %}
                    <tr>
                        <td><strong>{{ token.account_key }}</strong></td>
                        <td>{{ token.nombre }}</td>
                        <td>
                            <span class="badge bg-{{ token.status_class }}">
                                {{ token.status_text }}
                            </span>
                        </td>
                        <td>
                            {% if token.days_remaining == 9999 %}
                                <span class="text-info"><i class="bi bi-infinity"></i> Permanente</span>
                            {% elif token.days_remaining != None %}
                                {% if token.days_remaining > 15 %}
                                    <span class="text-success">{{ token.days_remaining }} dias</span>
                                {% elif token.days_remaining > 7 %}
                                    <span class="text-warning">{{ token.days_remaining }} dias</span>
                                {% elif token.days_remaining > 0 %}
                                    <span class="text-danger fw-bold">{{ token.days_remaining }} dias</span>
                                {% else %}
                                    <span class="text-danger fw-bold">Expirado</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if token.expiry_info %}
                                <small>{{ token.expiry_info }}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if token.has_credentials and token.has_token %}
                                <button class="btn btn-sm btn-outline-primary"
                                        onclick="renovarToken('{{ token.account_key }}', '{{ token.nombre }}')"
                                        {% if token.status == 'permanente' %}disabled{% endif %}>
                                    <i class="bi bi-arrow-repeat"></i> Renovar
                                </button>
                            {% else %}
                                <span class="text-muted">Sin credenciales</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No hay tokens configurados</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Historial -->
<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title mb-3"><i class="bi bi-clock-history me-2"></i>Historial de Renovaciones</h5>
        <div id="historialContainer">
            <div class="text-center text-muted py-3">
                <button class="btn btn-outline-secondary" onclick="cargarHistorial()">
                    <i class="bi bi-arrow-down-circle me-1"></i>Cargar Historial
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Instrucciones -->
<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title mb-3"><i class="bi bi-question-circle me-2"></i>Como obtener un nuevo token</h5>
        <ol class="mb-0">
            <li>Ve a <a href="https://developers.facebook.com/tools/explorer/" target="_blank">Graph API Explorer</a></li>
            <li>Selecciona tu aplicacion en el menu desplegable</li>
            <li>Haz clic en "Generate Access Token"</li>
            <li>Selecciona los permisos necesarios:
                <code>ads_read</code>, <code>ads_management</code>, <code>business_management</code>
            </li>
            <li>Copia el token generado</li>
            <li>Pegalo en <code>config.json</code> en el campo <code>access_token</code></li>
            <li>Haz clic en "Renovar" para convertirlo a token de larga duracion (60 dias)</li>
        </ol>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function verificarTodos() {
    showLoading('Verificando tokens...');
    try {
        const response = await fetch('/marketing/tokens/verificar/');
        const data = await response.json();
        hideLoading();

        if (data.status === 'success') {
            location.reload();
        } else {
            showAlert(data.message || 'Error verificando tokens', 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error: ' + error.message, 'danger');
    }
}

async function renovarToken(accountKey, nombre) {
    if (!confirm(`¿Renovar token de "${nombre}"?`)) return;

    showLoading(`Renovando token de ${nombre}...`);
    try {
        const response = await fetch(`/marketing/tokens/renovar/?account_key=${accountKey}`);
        const data = await response.json();
        hideLoading();

        if (data.status === 'success') {
            showAlert(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.message || 'Error renovando token', 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error: ' + error.message, 'danger');
    }
}

async function renovarTodos() {
    if (!confirm('¿Renovar todos los tokens próximos a expirar (menos de 15 días)?')) return;

    showLoading('Renovando tokens...');
    try {
        const response = await fetch('/marketing/tokens/renovar-todos/');
        const data = await response.json();
        hideLoading();

        if (data.status === 'success') {
            const stats = data.stats;
            showAlert(`Renovación completada: ${stats.renovados} renovados, ${stats.ok} OK, ${stats.errores} errores`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert(data.message || 'Error renovando tokens', 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error: ' + error.message, 'danger');
    }
}

async function cargarHistorial() {
    const container = document.getElementById('historialContainer');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>';

    try {
        const response = await fetch('/marketing/tokens/historial/');
        const data = await response.json();

        if (data.status === 'success' && data.renovations.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Fecha</th><th>Cuenta</th><th>Resultado</th><th>Detalles</th></tr></thead><tbody>';

            data.renovations.forEach(r => {
                const fecha = new Date(r.date).toLocaleString();
                const badge = r.success ? 'success' : 'danger';
                const texto = r.success ? `Renovado (${r.expires_in_days} días)` : `Error: ${r.error}`;

                html += `<tr>
                    <td><small>${fecha}</small></td>
                    <td><strong>[${r.account}]</strong> ${r.nombre}</td>
                    <td><span class="badge bg-${badge}">${r.success ? 'OK' : 'Error'}</span></td>
                    <td><small>${texto}</small></td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="text-center text-muted py-3">No hay historial de renovaciones</div>';
        }
    } catch (error) {
        container.innerHTML = `<div class="text-center text-danger py-3">Error: ${error.message}</div>`;
    }
}
</script>
{% endblock %}
